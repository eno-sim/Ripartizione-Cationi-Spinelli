import numpy as np
from iminuit import Minuit
from ripanto import RipartoSpinelli
 # Replace 'your_module' with the actual module name where RipartoSpinelli is defined


riparto = RipartoSpinelli.with_defaults()
'''
X0 = np.array([
    0.1253, 0.2006, 0.0264, 0.6451, 0.0020, 0.0000, 0.0000,
    1.3780, 0.0084, 0.0345, 0.1362, 0.0000, 0.4380, 0.0022
])


err0 = np.array([
    0.0020, 0.0049, 0.0039, 0.0036, 0.0010, 0.0000, 0.0000,
    0.0067, 0.0010, 0.0045, 0.0017, 0.0000, 0.0060, 0.0010
])
'''

'''
 1.            Al3+     0.1141    0.0019    0.0000    1.1225
 2.            Fe2+     0.2744    0.0046    0.0000    0.2792
 3.            Fe3+     0.0028    0.0000    0.0000    0.0899
 4.            Mg2+     0.6059    0.0101    0.0000    0.7266
 5.            Mn2+     0.0025    0.0000    0.0000    0.0025
 6.            Cr3+     0.0000    0.0000    0.0000    0.7929
 7.            Ti4+     0.0000    0.0000    0.0000    0.0025
 8.            Al3+     1.0091    0.0168    0.0000    1.1225
 9.            Fe2+     0.0000    0.0000    0.0000    0.2792
10.            Fe3+     0.0849    0.0014    0.0000    0.0899
11.            Mg2+     0.1136    0.0019    0.0000    0.7266
12.            Mn2+     0.0000    0.0000    0.0000    0.0025
13.            Cr3+     0.7891    0.0132    0.0000    0.7929
14.            Ti4+     0.0017    0.0000    0.0000    0.0025
'''

X1 = np.array([
    0.1141, 0.2744, 0.0028, 0.6059, 0.0025, 0.0000, 0.0000,
    1.0091, 0.0000, 0.0849, 0.1136, 0.0000, 0.7891, 0.0017
])
err1 = np.array([
    0.0019, 0.0046, 0.0000, 0.0101, 0.0000, 0.0000, 0.0000,
    0.0168, 0.0000, 0.0014, 0.0019, 0.0000, 0.0132, 0.0000
])

input_file = "SP-3G51A.IN"
dis_file = "RIP99A.DIS" 

RipartoSpinelli.prepare_input_file(input_file)



def fcn_wrapper(*X):
    X = np.array(X)
    # For the first call, use IFLAG=1 to initialize reading input/dis files
    # (like Fortran CALL FCN(1))
    if not hasattr(riparto, 'initialized'):
        riparto.initialized = True
        F_initial = riparto.FCN(X, 1, input_file, dis_file)
        print(f"Initial F = {F_initial}")
        print('1')
        return F_initial
    else:
        # Subsequent calls use IFLAG=3 (as in MIGRAD / IMPROVE / CALL FCN 3)
        print('2')
        return riparto.FCN(X, 3, input_file, dis_file)


m = Minuit(fcn_wrapper, *X1)

# Set limits or constraints if needed
for i in range(len(X1)):
    if i < len(X1)//2:
        m.limits[i] = (0,1)  # example bounds; tune as needed
    else:
        m.limits[i] = (0,2)
  # example bounds; tune as needed
   # else :
   #     m.limits[i] = (0.0, 2)


# Optionally set strategy, tolerance, etc.
m.strategy = 2
m.tol = 1e-4
m.simplex()
m.migrad()
m.simplex()


# CALL FCN 3 equivalent â€” evaluate FCN with the best-fit parameters
final_F = riparto.FCN(np.array(m.values), 3, input_file, dis_file)
print(f"Final minimized F = {final_F}")


print("Best-fit parameters:")
print(m.values)
print("Parameter errors:")
print(m.errors)
print('Limits:')
print(m.limits)
